stages:
  - build
  - deploy
  - cleanup

build:
  stage: build
  script:
    - echo "BUILD STARTED!"
    - java -version
    - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-17.0.11.0.9-2.el9.x86_64
    - docker rmi -f autobackend:latest || true
    - docker build -t autobackend:latest .
    - echo "BUILD COMPLETED!"
  only:
    - master
  allow_failure: false

deploy:
  stage: deploy
  script:
    - echo "DEPLOY STARTED!"
    - mkdir -p /home/admin/projects/auto/back
    - cp docker-compose.yml /home/admin/projects/auto/back/
    - cd /home/admin/projects/auto/back
    - docker-compose down || true
    - docker-compose up -d
    - echo "DEPLOY COMPLETED!"
  only:
    - master

cleanup:
  stage: cleanup
  when: always
  script:
    - echo "CLEANUP STARTED!"
    - docker system prune -a -f --volumes --filter "until=24h"
    - echo "CLEANUP COMPLETED!"